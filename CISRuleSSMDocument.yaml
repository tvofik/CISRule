---
schemaVersion: "2.2"
description: "Check Registry of Instance for compliance"
parameters:
  commands:
    type: String
    description: "(Required) The commands to run on the instance."
    default: "{{ ssm:CISRule }}"
mainSteps:
  - precondition:
      StringEquals:
        - platformType
        - Windows
    action: "aws:runPowerShellScript"
    name: "example"
    inputs:
      timeoutSeconds: "60"
      runCommand:
        - |
          $collection = '{{commands}}'

          $baseRegistryPath = "HKLM:\"
          $compliant=0
          $nonComplaint=0

          $collectionObject = ConvertFrom-Json $collection

          foreach ($item in $collectionObject) {
              $PathParts = ($item.Path).Split(":")
              $expectedValue = $item.ExpectedValue

              $registryPath = $PathParts[0]
              $propertyName = $PathParts[-1]

              $fullRegistryPath = $baseRegistryPath + $registryPath.Trim()
              
              $result = (Get-ItemProperty -Path $fullRegistryPath).$propertyName

              if ($result -eq $expectedValue){
                  $compliant++
              } else {
                  $nonComplaint++
              }
          }

          Write-Host "Completed CIS Checks`nRESULT: $compliant compliant and $nonComplaint non-compliant items"
